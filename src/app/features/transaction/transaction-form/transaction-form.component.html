<div class="transaction-form-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="title-section">
      <button mat-icon-button routerLink="/transactions" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="title-info">
        <h1>{{ isEditMode ? 'Edit Transaction' : 'Add New Transaction' }}</h1>
        <p class="subtitle">{{ isEditMode ? 'Update transaction details' : 'Enter transaction information' }}</p>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="loading$ | async">
    <mat-spinner diameter="50"></mat-spinner>
    <p>{{ isEditMode ? 'Loading transaction...' : 'Processing...' }}</p>
  </div>

  <!-- Transaction Form -->
  <div class="form-content" *ngIf="!(loading$ | async)">
    <mat-horizontal-stepper #stepper linear="false" class="transaction-stepper">
      
      <!-- Step 1: Transaction Details -->
      <mat-step [stepControl]="transactionForm" label="Transaction Details">
        <mat-card class="step-card">
          <mat-card-header>
            <mat-card-title>Transaction Information</mat-card-title>
            <mat-card-subtitle>Enter the basic transaction details</mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <form [formGroup]="transactionForm" class="transaction-form">
              
              <!-- Card Selection -->
              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Select Card</mat-label>
                  <mat-select formControlName="cardId" [disabled]="isEditMode">
                    <mat-option *ngFor="let card of cards$ | async" [value]="card.id">
                      {{ card.cardNumber }} - {{ card.cardholderName }}
                    </mat-option>
                  </mat-select>
                  <mat-error>{{ getErrorMessage('cardId') }}</mat-error>
                </mat-form-field>
              </div>

              <!-- Selected Card Info -->
              <div class="card-info" *ngIf="selectedCard">
                <mat-card class="selected-card">
                  <mat-card-content>
                    <div class="card-details">
                      <div class="card-item">
                        <label>Card Number</label>
                        <span>{{ selectedCard.cardNumber }}</span>
                      </div>
                      <div class="card-item">
                        <label>Cardholder</label>
                        <span>{{ selectedCard.cardholderName }}</span>
                      </div>
                      <div class="card-item">
                        <label>Available Credit</label>
                        <span class="amount">{{ formatCurrency(selectedCard.availableCredit) }}</span>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>

              <!-- Transaction Type and Amount -->
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Transaction Type</mat-label>
                  <mat-select formControlName="transactionType" [disabled]="isEditMode">
                    <mat-option *ngFor="let type of transactionTypes" [value]="type.code">
                      {{ type.name }}
                    </mat-option>
                  </mat-select>
                  <mat-hint *ngIf="transactionForm.get('transactionType')?.value">
                    {{ getTransactionTypeDescription(transactionForm.get('transactionType')?.value) }}
                  </mat-hint>
                  <mat-error>{{ getErrorMessage('transactionType') }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Amount</mat-label>
                  <input matInput type="number" formControlName="amount" step="0.01" min="0.01" [disabled]="isEditMode">
                  <span matPrefix>$</span>
                  <mat-hint *ngIf="getTransactionTypeMaxAmount(transactionForm.get('transactionType')?.value)">
                    Max: {{ formatCurrency(getTransactionTypeMaxAmount(transactionForm.get('transactionType')?.value)!) }}
                  </mat-hint>
                  <mat-error>{{ getErrorMessage('amount') }}</mat-error>
                </mat-form-field>
              </div>

              <!-- Currency and Original Amount -->
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Currency</mat-label>
                  <mat-select formControlName="currency">
                    <mat-option value="USD">USD - US Dollar</mat-option>
                    <mat-option value="EUR">EUR - Euro</mat-option>
                    <mat-option value="GBP">GBP - British Pound</mat-option>
                    <mat-option value="CAD">CAD - Canadian Dollar</mat-option>
                    <mat-option value="JPY">JPY - Japanese Yen</mat-option>
                  </mat-select>
                  <mat-error>{{ getErrorMessage('currency') }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Original Amount (Optional)</mat-label>
                  <input matInput type="number" formControlName="originalAmount" step="0.01" min="0">
                  <mat-hint>For foreign currency transactions</mat-hint>
                  <mat-error>{{ getErrorMessage('originalAmount') }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Original Currency (Optional)</mat-label>
                  <mat-select formControlName="originalCurrency">
                    <mat-option value="">Select Currency</mat-option>
                    <mat-option value="USD">USD</mat-option>
                    <mat-option value="EUR">EUR</mat-option>
                    <mat-option value="GBP">GBP</mat-option>
                    <mat-option value="CAD">CAD</mat-option>
                    <mat-option value="JPY">JPY</mat-option>
                  </mat-select>
                  <mat-error>{{ getErrorMessage('originalCurrency') }}</mat-error>
                </mat-form-field>
              </div>

              <!-- Description -->
              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Description</mat-label>
                  <input matInput formControlName="description" maxlength="255">
                  <mat-hint align="end">{{ transactionForm.get('description')?.value?.length || 0 }}/255</mat-hint>
                  <mat-error>{{ getErrorMessage('description') }}</mat-error>
                </mat-form-field>
              </div>

              <!-- Merchant Information -->
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Merchant Name</mat-label>
                  <input matInput formControlName="merchantName" maxlength="100">
                  <mat-error>{{ getErrorMessage('merchantName') }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Merchant Category</mat-label>
                  <mat-select formControlName="merchantCategory">
                    <mat-option value="retail">Retail</mat-option>
                    <mat-option value="restaurant">Restaurant</mat-option>
                    <mat-option value="gas_station">Gas Station</mat-option>
                    <mat-option value="grocery">Grocery</mat-option>
                    <mat-option value="online">Online</mat-option>
                    <mat-option value="entertainment">Entertainment</mat-option>
                    <mat-option value="travel">Travel</mat-option>
                    <mat-option value="healthcare">Healthcare</mat-option>
                    <mat-option value="other">Other</mat-option>
                  </mat-select>
                  <mat-error>{{ getErrorMessage('merchantCategory') }}</mat-error>
                </mat-form-field>
              </div>
            </form>
          </mat-card-content>
          
          <mat-card-actions>
            <button mat-button matStepperNext [disabled]="transactionForm.invalid">
              Next
              <mat-icon>navigate_next</mat-icon>
            </button>
          </mat-card-actions>
        </mat-card>
      </mat-step>

      <!-- Step 2: Location Information -->
      <mat-step [stepControl]="locationForm" label="Location Information">
        <mat-card class="step-card">
          <mat-card-header>
            <mat-card-title>Transaction Location</mat-card-title>
            <mat-card-subtitle>Enter where the transaction took place</mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <form [formGroup]="locationForm" class="location-form">
              
              <!-- Country and City -->
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Country</mat-label>
                  <input matInput formControlName="country" maxlength="50">
                  <mat-error>{{ getErrorMessage('country', locationForm) }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>City</mat-label>
                  <input matInput formControlName="city" maxlength="50">
                  <mat-error>{{ getErrorMessage('city', locationForm) }}</mat-error>
                </mat-form-field>
              </div>

              <!-- Address -->
              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Address (Optional)</mat-label>
                  <input matInput formControlName="address" maxlength="200">
                  <mat-hint align="end">{{ locationForm.get('address')?.value?.length || 0 }}/200</mat-hint>
                  <mat-error>{{ getErrorMessage('address', locationForm) }}</mat-error>
                </mat-form-field>
              </div>

              <!-- Coordinates -->
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Latitude (Optional)</mat-label>
                  <input matInput type="number" formControlName="latitude" step="0.000001">
                  <mat-hint>Decimal degrees format</mat-hint>
                  <mat-error>{{ getErrorMessage('latitude', locationForm) }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Longitude (Optional)</mat-label>
                  <input matInput type="number" formControlName="longitude" step="0.000001">
                  <mat-hint>Decimal degrees format</mat-hint>
                  <mat-error>{{ getErrorMessage('longitude', locationForm) }}</mat-error>
                </mat-form-field>
              </div>
            </form>
          </mat-card-content>
          
          <mat-card-actions>
            <button mat-button matStepperPrevious>
              <mat-icon>navigate_before</mat-icon>
              Previous
            </button>
            <button mat-button matStepperNext [disabled]="locationForm.invalid">
              Next
              <mat-icon>navigate_next</mat-icon>
            </button>
          </mat-card-actions>
        </mat-card>
      </mat-step>

      <!-- Step 3: Review and Submit -->
      <mat-step label="Review & Submit">
        <mat-card class="step-card">
          <mat-card-header>
            <mat-card-title>Review Transaction</mat-card-title>
            <mat-card-subtitle>Please review the transaction details before submitting</mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <div class="review-section">
              
              <!-- Transaction Summary -->
              <div class="review-group">
                <h3>Transaction Details</h3>
                <mat-divider></mat-divider>
                <div class="review-grid">
                  <div class="review-item">
                    <label>Amount</label>
                    <span class="value amount">{{ formatCurrency(transactionForm.get('amount')?.value, transactionForm.get('currency')?.value) }}</span>
                  </div>
                  <div class="review-item">
                    <label>Type</label>
                    <span class="value">{{ transactionForm.get('transactionType')?.value | titlecase }}</span>
                  </div>
                  <div class="review-item">
                    <label>Description</label>
                    <span class="value">{{ transactionForm.get('description')?.value }}</span>
                  </div>
                  <div class="review-item">
                    <label>Merchant</label>
                    <span class="value">{{ transactionForm.get('merchantName')?.value }}</span>
                  </div>
                </div>
              </div>

              <!-- Location Summary -->
              <div class="review-group">
                <h3>Location</h3>
                <mat-divider></mat-divider>
                <div class="review-grid">
                  <div class="review-item">
                    <label>Country</label>
                    <span class="value">{{ locationForm.get('country')?.value }}</span>
                  </div>
                  <div class="review-item">
                    <label>City</label>
                    <span class="value">{{ locationForm.get('city')?.value }}</span>
                  </div>
                  <div class="review-item" *ngIf="locationForm.get('address')?.value">
                    <label>Address</label>
                    <span class="value">{{ locationForm.get('address')?.value }}</span>
                  </div>
                </div>
              </div>

              <!-- Validation Results -->
              <div class="validation-section" *ngIf="validationResult">
                <h3>Validation Results</h3>
                <mat-divider></mat-divider>
                
                <div class="validation-status" [class.valid]="validationResult.isValid" [class.invalid]="!validationResult.isValid">
                  <mat-icon>{{ validationResult.isValid ? 'check_circle' : 'error' }}</mat-icon>
                  <span>{{ validationResult.isValid ? 'Validation Passed' : 'Validation Failed' }}</span>
                </div>

                <div class="validation-errors" *ngIf="validationResult.errors.length > 0">
                  <h4>Errors:</h4>
                  <ul>
                    <li *ngFor="let error of validationResult.errors" class="error-item">
                      {{ error.message }}
                    </li>
                  </ul>
                </div>

                <div class="validation-warnings" *ngIf="validationResult.warnings.length > 0">
                  <h4>Warnings:</h4>
                  <ul>
                    <li *ngFor="let warning of validationResult.warnings" class="warning-item">
                      {{ warning.message }}
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </mat-card-content>
          
          <mat-card-actions>
            <button mat-button matStepperPrevious>
              <mat-icon>navigate_before</mat-icon>
              Previous
            </button>
            <button mat-stroked-button (click)="validateTransaction()" [disabled]="transactionForm.invalid || locationForm.invalid">
              <mat-icon>verified</mat-icon>
              Validate
            </button>
            <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="transactionForm.invalid || locationForm.invalid">
              <mat-icon>{{ isEditMode ? 'save' : 'add' }}</mat-icon>
              {{ isEditMode ? 'Update Transaction' : 'Create Transaction' }}
            </button>
          </mat-card-actions>
        </mat-card>
      </mat-step>
    </mat-horizontal-stepper>

    <!-- Form Actions -->
    <div class="form-actions">
      <button mat-stroked-button (click)="cancel()">
        <mat-icon>cancel</mat-icon>
        Cancel
      </button>
    </div>
  </div>
</div>